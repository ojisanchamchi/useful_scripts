<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Triển khai ImunifyAV tự động cho Bitrix | Useful Scripts Documentation</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Triển khai ImunifyAV tự động cho Bitrix" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Bài viết này tổng hợp lại toàn bộ script trong thư mục imunifyav/ và hướng dẫn bạn tái sử dụng chúng để triển khai ImunifyAV nhanh chóng cho hạ tầng Bitrix." />
<meta property="og:description" content="Bài viết này tổng hợp lại toàn bộ script trong thư mục imunifyav/ và hướng dẫn bạn tái sử dụng chúng để triển khai ImunifyAV nhanh chóng cho hạ tầng Bitrix." />
<link rel="canonical" href="https://yourusername.github.io/useful_scripts/2025/10/16/imunifyav-trien-khai-bitrix.html" />
<meta property="og:url" content="https://yourusername.github.io/useful_scripts/2025/10/16/imunifyav-trien-khai-bitrix.html" />
<meta property="og:site_name" content="Useful Scripts Documentation" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-10-16T00:00:00+07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Triển khai ImunifyAV tự động cho Bitrix" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-10-16T00:00:00+07:00","datePublished":"2025-10-16T00:00:00+07:00","description":"Bài viết này tổng hợp lại toàn bộ script trong thư mục imunifyav/ và hướng dẫn bạn tái sử dụng chúng để triển khai ImunifyAV nhanh chóng cho hạ tầng Bitrix.","headline":"Triển khai ImunifyAV tự động cho Bitrix","mainEntityOfPage":{"@type":"WebPage","@id":"https://yourusername.github.io/useful_scripts/2025/10/16/imunifyav-trien-khai-bitrix.html"},"url":"https://yourusername.github.io/useful_scripts/2025/10/16/imunifyav-trien-khai-bitrix.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/useful_scripts/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://yourusername.github.io/useful_scripts/feed.xml" title="Useful Scripts Documentation" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/useful_scripts/">Useful Scripts Documentation</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Triển khai ImunifyAV tự động cho Bitrix</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-10-16T00:00:00+07:00" itemprop="datePublished">Oct 16, 2025
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <blockquote>
  <p>Bài viết này tổng hợp lại toàn bộ script trong thư mục <code class="language-plaintext highlighter-rouge">imunifyav/</code> và hướng dẫn bạn tái sử dụng chúng để triển khai ImunifyAV nhanh chóng cho hạ tầng Bitrix.</p>
</blockquote>

<h2 id="tổng-quan-giải-pháp">Tổng quan giải pháp</h2>
<ul>
  <li>Bộ script giúp tự động hoá quá trình cài đặt ImunifyAV, cấu hình tích hợp với giao diện Bitrix và thiết lập cảnh báo khi phát hiện mã độc.</li>
  <li>Hai script cài đặt chính hỗ trợ song song cho môi trường CentOS/CloudLinux (<code class="language-plaintext highlighter-rouge">iav_setup.sh</code>) và Debian (<code class="language-plaintext highlighter-rouge">iav_setup_debian.sh</code>), trong khi các script còn lại đóng vai trò hỗ trợ (cung cấp dữ liệu người dùng/domain, hook thông báo, proxy repo…).</li>
  <li>Tất cả đều giả định hệ thống chạy với user <code class="language-plaintext highlighter-rouge">bitrix</code>, thư mục web chính <code class="language-plaintext highlighter-rouge">/home/bitrix/www</code> (hoặc <code class="language-plaintext highlighter-rouge">/var/www/bitrix/default</code> trên Debian) và yêu cầu sẵn quyền <code class="language-plaintext highlighter-rouge">root</code>.</li>
</ul>

<h2 id="chuẩn-bị-trước-khi-chạy">Chuẩn bị trước khi chạy</h2>
<ul>
  <li>SMTP nội bộ hoạt động để script có thể gửi email qua <code class="language-plaintext highlighter-rouge">mailx</code>.</li>
  <li>Cài sẵn <code class="language-plaintext highlighter-rouge">curl</code>, <code class="language-plaintext highlighter-rouge">wget</code> và đảm bảo truy cập được tới internet. Nếu bị chặn HTTPS tới CloudLinux, cấu hình thêm reverse proxy theo mẫu <code class="language-plaintext highlighter-rouge">nginx_proxy.conf</code>.</li>
  <li>Xác định email nhận cảnh báo, ví dụ <code class="language-plaintext highlighter-rouge">security@example.com</code>.</li>
  <li>Với Debian, cần các package: <code class="language-plaintext highlighter-rouge">s-nail</code>, <code class="language-plaintext highlighter-rouge">jq</code>.</li>
</ul>

<h2 id="các-script-thành-phần">Các script thành phần</h2>
<ul>
  <li><strong>get-users.sh</strong>: trả về danh sách user tích hợp cho ImunifyAV thông qua <code class="language-plaintext highlighter-rouge">jq</code>. Mặc định tạo user <code class="language-plaintext highlighter-rouge">bitrix</code> với UID 600.</li>
  <li><strong>get-domains.sh</strong>: cung cấp thông tin domain chính và domain phụ của Bitrix, giúp giao diện Imunify hiển thị đúng cấu trúc thư mục.</li>
  <li><strong>iav_hook.sh</strong>: hook đa năng đọc payload JSON, gửi mail hoặc lưu file nhật ký. Bạn chỉ việc chỉnh <code class="language-plaintext highlighter-rouge">MAIL_TO</code> và thư mục lưu.</li>
  <li><strong>iav_notify.sh</strong>: phương án gửi thông báo siêu gọn (một dòng email). Có thể dùng độc lập nếu không cần logic phức tạp.</li>
  <li><strong>iav_setup.sh / iav_setup_debian.sh</strong>: trái tim của quá trình cài đặt. Chúng tải toàn bộ script hỗ trợ, tạo symlink giao diện, cấu hình ignore list, thiết lập lịch quét, cập nhật tham số hiệu năng, và đăng ký hook thông báo.</li>
  <li><strong>nginx_proxy.conf</strong>: template cấu hình Nginx reverse proxy tới các endpoint của CloudLinux phòng trường hợp mạng nội bộ chặn HTTPS trực tiếp.</li>
</ul>

<h2 id="cài-đặt-trên-centoscloudlinux">Cài đặt trên CentOS/CloudLinux</h2>
<p>Chạy script với tham số email nhận cảnh báo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-sL</span> https://raw.githubusercontent.com/YogSottot/useful_scripts/master/imunifyav/iav_setup.sh <span class="se">\</span>
  | bash <span class="nt">-s</span> <span class="nt">--</span> security@example.com
</code></pre></div></div>

<p>Script sẽ thực hiện:</p>
<ul>
  <li>Cài <code class="language-plaintext highlighter-rouge">mailx</code>, <code class="language-plaintext highlighter-rouge">jq</code>, <code class="language-plaintext highlighter-rouge">oniguruma</code>.</li>
  <li>Tạo <code class="language-plaintext highlighter-rouge">/etc/sysconfig/imunify360/integration.conf</code> và map các script <code class="language-plaintext highlighter-rouge">get-users.sh</code>, <code class="language-plaintext highlighter-rouge">get-domains.sh</code>.</li>
  <li>Đồng bộ thư mục giao diện <code class="language-plaintext highlighter-rouge">/opt/iav/.imunifyav</code> vào <code class="language-plaintext highlighter-rouge">/home/bitrix/www/</code>.</li>
  <li>Tải về hook/utility script, set quyền thực thi và chèn email vào <code class="language-plaintext highlighter-rouge">iav_hook.sh</code>.</li>
  <li>Cài ImunifyAV thông qua <code class="language-plaintext highlighter-rouge">imav-deploy.sh</code> (mặc định lấy từ mirror <code class="language-plaintext highlighter-rouge">imun.0fr.ru</code>).</li>
  <li>Đăng ký hook cho sự kiện <code class="language-plaintext highlighter-rouge">USER_SCAN_MALWARE_FOUND</code> và <code class="language-plaintext highlighter-rouge">CUSTOM_SCAN_MALWARE_FOUND</code>.</li>
  <li>Thêm danh sách thư mục bỏ qua (cache, backup, upload của Bitrix).</li>
  <li>Tuỳ chỉnh cấu hình scan (Hyperscan, giới hạn CPU/IO/RAM) và tạo cron quét hằng ngày lúc 01:10.</li>
  <li>Điều chỉnh <code class="language-plaintext highlighter-rouge">login.defs</code> để UID/GID 600 trở thành user thường, phù hợp với user <code class="language-plaintext highlighter-rouge">bitrix</code>.</li>
</ul>

<h2 id="cài-đặt-trên-debian">Cài đặt trên Debian</h2>
<p>Thao tác tương tự nhưng dùng script dành riêng:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-sL</span> https://raw.githubusercontent.com/YogSottot/useful_scripts/master/imunifyav/iav_setup_debian.sh <span class="se">\</span>
  | bash <span class="nt">-s</span> <span class="nt">--</span> security@example.com
</code></pre></div></div>

<p>Điểm khác biệt:</p>
<ul>
  <li>Dùng <code class="language-plaintext highlighter-rouge">apt</code> và <code class="language-plaintext highlighter-rouge">s-nail</code>.</li>
  <li>Symlink giao diện về <code class="language-plaintext highlighter-rouge">/var/www/bitrix/default</code>.</li>
  <li>Mirror repo sử dụng domain <code class="language-plaintext highlighter-rouge">repoimun.0fr.ru</code> và <code class="language-plaintext highlighter-rouge">filesimun.0fr.ru</code>, <code class="language-plaintext highlighter-rouge">apiimun.0fr.ru</code>.</li>
  <li>Chỉnh sửa đường dẫn bỏ qua, cron và ignore list tương ứng môi trường Debian.</li>
  <li>Trigger khởi động lại hàng loạt service Imunify để áp dụng cấu hình mới.</li>
</ul>

<h2 id="tuỳ-chỉnh-cảnh-báo-và-lưu-trữ">Tuỳ chỉnh cảnh báo và lưu trữ</h2>
<ul>
  <li>Để nhận mail giàu thông tin, bật <code class="language-plaintext highlighter-rouge">MAIL_ENABLE=yes</code> trong <code class="language-plaintext highlighter-rouge">iav_hook.sh</code> và cấu hình <code class="language-plaintext highlighter-rouge">MAIL_TO</code>.</li>
  <li>Nếu cần lưu log, giữ <code class="language-plaintext highlighter-rouge">FILE_ENABLE=yes</code>; script sẽ tạo thư mục <code class="language-plaintext highlighter-rouge">/tmp/imunify-script-files</code> và log theo tên sự kiện.</li>
  <li>Có thể thêm custom handler bên dưới mỗi <code class="language-plaintext highlighter-rouge"># append your stuff here</code> để gọi webhook, Slack, Telegram…</li>
</ul>

<h2 id="quản-lý-danh-sách-bỏ-qua">Quản lý danh sách bỏ qua</h2>
<ul>
  <li>Các script thêm sẵn ignore list cho cache/backup của Bitrix để tránh false positive.</li>
  <li>Nếu bạn lưu mã nguồn ở thư mục khác, bổ sung vào <code class="language-plaintext highlighter-rouge">/etc/sysconfig/imunify360/malware-filters-admin-conf/ignored.txt</code>.</li>
  <li>Khi cần quét đầy đủ, có thể tạm thời xoá các dòng ignore và chạy:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>imunify-antivirus update sigs
imunify-antivirus malware on-demand start <span class="nt">--path</span><span class="o">=</span><span class="s1">'/home/bitrix/'</span> <span class="nt">--file-mask</span><span class="o">=</span><span class="s2">"*.php,*.js,*.html,.htaccess"</span>
</code></pre></div></div>

<h2 id="lịch-quét-và-tài-nguyên">Lịch quét và tài nguyên</h2>
<ul>
  <li>Cron mặc định chạy lúc 01:10 mỗi ngày: cập nhật chữ ký trước khi quét.</li>
  <li>Tham số <code class="language-plaintext highlighter-rouge">--intensity-cpu</code> và <code class="language-plaintext highlighter-rouge">--intensity-io</code> được đặt ở mức 3, phù hợp server vừa phải. Điều chỉnh tại <code class="language-plaintext highlighter-rouge">/etc/cron.d/iav_scan_schedule</code>.</li>
  <li>Các lệnh <code class="language-plaintext highlighter-rouge">imunify-antivirus config update</code> trong script đã giới hạn CPU/IO/RAM khi quét để không ảnh hưởng website.</li>
</ul>

<h2 id="kiểm-tra-sau-cài-đặt">Kiểm tra sau cài đặt</h2>
<ol>
  <li>Đăng nhập giao diện ImunifyAV và xác minh danh sách domain hiển thị đúng.</li>
  <li>Thực hiện quét thử rồi kiểm tra email/đường dẫn log nhận được từ <code class="language-plaintext highlighter-rouge">iav_hook.sh</code>.</li>
  <li>Đảm bảo cron đã tạo: <code class="language-plaintext highlighter-rouge">crontab -l -u root | grep iav_scan_schedule</code>.</li>
  <li>Theo dõi <code class="language-plaintext highlighter-rouge">/opt/iav/</code> xem các script có cập nhật và quyền sở hữu <code class="language-plaintext highlighter-rouge">root:_imunify</code>.</li>
</ol>

<h2 id="gợi-ý-bảo-trì">Gợi ý bảo trì</h2>
<ul>
  <li>Khi CloudLinux thay đổi endpoint, cập nhật các mirror trong <code class="language-plaintext highlighter-rouge">nginx_proxy.conf</code> và phần <code class="language-plaintext highlighter-rouge">sed</code> của script.</li>
  <li>Giữ <code class="language-plaintext highlighter-rouge">jq</code>, <code class="language-plaintext highlighter-rouge">imunify-antivirus</code> ở phiên bản mới. Có thể tự động hoá bằng cron <code class="language-plaintext highlighter-rouge">yum update imunify-antivirus</code> hoặc <code class="language-plaintext highlighter-rouge">apt upgrade</code>.</li>
  <li>Định kỳ rà soát ignore list để tránh bỏ sót file độc hại mới.</li>
</ul>

<p>Với bộ script này, bạn có thể chuẩn hoá việc triển khai ImunifyAV cho nhiều máy chủ Bitrix, giảm thao tác thủ công và đảm bảo mỗi đợt quét đều gửi cảnh báo kịp thời.</p>

  </div><a class="u-url" href="/useful_scripts/2025/10/16/imunifyav-trien-khai-bitrix.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/useful_scripts/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Useful Scripts Documentation</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Useful Scripts Documentation</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ojisanchamchi"><svg class="svg-icon"><use xlink:href="/useful_scripts/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ojisanchamchi</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>A blog for documenting how and when to use the scripts in this repository.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
